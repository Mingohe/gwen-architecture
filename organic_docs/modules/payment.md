# 支付与钱包系统模块 - 业务概述

> **返回**: [文档首页](../../README.md)  
> **前端文档**: [支付与钱包系统模块 - 前端文档](../frontend/payment.md)  
> **后端文档**: [支付与钱包系统模块 - 后端文档](../backend/payment.md)

## 目录

- [1. 模块概述](#1-模块概述)
- [2. 核心业务概念](#2-核心业务概念)
- [3. 业务流程](#3-业务流程)
- [4. 业务规则](#4-业务规则)
- [5. 模块关联](#5-模块关联)
- [6. 详细文档链接](#6-详细文档链接)

---

## 1. 模块概述

### 1.1 模块定位

支付与钱包系统模块是GWEN系统的支付和钱包管理模块，支持Stripe支付集成、Web3钱包管理和交易记录，用于处理系统的支付和钱包相关业务。

### 1.2 核心业务功能

- **Stripe Connect集成**: 集成Stripe支付平台，支持多种支付方式
- **USDC稳定币支持**: 支持USDC稳定币钱包管理
- **Web3钱包管理**: 管理Web3钱包地址和余额
- **交易记录追踪**: 记录和追踪所有交易记录

### 1.3 业务价值

- **支付处理**: 通过Stripe处理支付业务
- **钱包管理**: 统一管理用户钱包和余额
- **交易透明**: 通过交易记录实现交易透明
- **多币种支持**: 支持多种货币和稳定币

---

## 2. 核心业务概念

### 2.1 钱包状态

| 状态 | 状态值 | 说明 |
|------|--------|------|
| 活跃 | 0 | 钱包正常使用 |
| 冻结 | 1 | 钱包被冻结 |
| 关闭 | 2 | 钱包已关闭 |

### 2.2 交易类型

- **充值** (0): 向钱包充值
- **提现** (1): 从钱包提现
- **转账** (2): 钱包间转账

### 2.3 交易状态

- **待处理** (0): 交易已创建，等待处理
- **成功** (1): 交易成功完成
- **失败** (2): 交易处理失败

### 2.4 支付方式

- **Stripe支付**: 通过Stripe处理信用卡支付
- **USDC稳定币**: 通过USDC稳定币进行支付
- **Web3钱包**: 通过Web3钱包进行支付

---

## 3. 业务流程

### 3.1 钱包初始化流程

```
1. 用户首次使用钱包功能
   ↓
2. 系统自动创建Stripe Connect账户
   ↓
3. 创建钱包记录
   ↓
4. 生成钱包地址（Web3）
   ↓
5. 钱包初始化完成
```

### 3.2 支付流程

```
1. 用户发起支付
   ↓
2. 选择支付方式
   - Stripe支付
   - USDC稳定币
   ↓
3. 创建支付意图
   ↓
4. 处理支付
   ↓
5. 支付结果：
   ├─ [成功] → 更新钱包余额，记录交易
   └─ [失败] → 记录失败交易
```

### 3.3 交易记录流程

```
1. 交易发生
   ↓
2. 创建交易记录
   ↓
3. 更新钱包余额
   ↓
4. 交易记录出现在交易列表中
   ↓
5. 用户可以查看交易详情
```

### 3.4 Webhook处理流程

```
1. Stripe发送Webhook事件
   ↓
2. 系统接收Webhook
   ↓
3. 验证Webhook签名
   ↓
4. 处理事件
   - payment_intent.succeeded
   - payment_intent.payment_failed
   - account.updated
   ↓
5. 更新钱包和交易状态
```

---

## 4. 业务规则

### 4.1 钱包管理规则

1. **自动创建**: 用户首次使用时自动创建钱包
2. **唯一性**: 每个用户只能有一个钱包
3. **状态管理**: 钱包状态必须按照预定义流程流转
4. **余额验证**: 余额不能为负数

### 4.2 支付处理规则

1. **支付意图**: 支付前必须创建支付意图
2. **金额验证**: 支付金额必须大于0
3. **状态跟踪**: 支付状态必须实时跟踪
4. **失败处理**: 支付失败需要记录和通知

### 4.3 交易记录规则

1. **完整记录**: 所有交易必须完整记录
2. **状态更新**: 交易状态必须实时更新
3. **余额同步**: 交易后必须同步更新钱包余额
4. **不可篡改**: 交易记录一旦创建不能修改

### 4.4 Webhook处理规则

1. **签名验证**: 必须验证Webhook签名
2. **幂等性**: Webhook处理必须保证幂等性
3. **事件处理**: 必须处理所有相关事件
4. **错误处理**: Webhook处理失败需要重试

---

## 5. 模块关联

### 5.1 与用户系统关联

- 钱包归属于用户
- 交易记录关联到用户
- 用户对账明细包含钱包交易

### 5.2 与财务系统关联

- 钱包交易可能涉及财务记录
- 钱包余额可能影响财务统计

### 5.3 与任务系统关联

- 任务奖励可能通过钱包支付
- 任务金币可能转换为钱包余额

---

## 6. 详细文档链接

### 6.1 前端文档

详细的前端实现文档请参考：[支付与钱包系统模块 - 前端文档](../frontend/payment.md)

包含内容：
- 页面结构和路由
- 组件结构和说明
- Store 状态管理
- API 调用规范
- 交互流程
- UI 规范
- 权限控制

### 6.2 后端文档

详细的后端实现文档请参考：[支付与钱包系统模块 - 后端文档](../backend/payment.md)

包含内容：
- 数据模型（Model/Schema）
- API 规范（Controller/Route）
- 业务逻辑流程（Service/UseCase）
- 权限与鉴权规则
- 错误码和响应规范
- 定时任务/队列处理/事件

---

**文档版本**: v1.0  
**最后更新**: 2025-11-19  
**维护者**: GWEN开发团队
