# 笔记系统模块 - 业务概述

> **返回**: [文档首页](../README.md)  
> **前端文档**: [笔记系统模块 - 前端文档](../frontend/note.md)  
> **后端文档**: [笔记系统模块 - 后端文档](../backend/note.md)

## 目录

- [1. 模块概述](#1-模块概述)
- [2. 核心业务概念](#2-核心业务概念)
- [3. 业务流程](#3-业务流程)
- [4. 业务规则](#4-业务规则)
- [5. 模块关联](#5-模块关联)
- [6. 详细文档链接](#6-详细文档链接)

---

## 1. 模块概述

### 1.1 模块定位

笔记系统模块是GWEN系统的个人知识管理模块，支持个人笔记管理、多人协作编辑、笔记分享和实时同步功能。

### 1.2 核心业务功能

- **笔记管理**: 创建、编辑、删除个人笔记
- **笔记分类**: 通过标签（任务、灵感、其他）组织笔记
- **笔记搜索**: 支持按标签和内容搜索笔记
- **笔记分享**: 支持将笔记分享给其他用户，设置只读/可编辑权限
- **协作编辑**: 支持多人实时协作编辑，通过编辑锁机制防止冲突
- **实时同步**: 通过WebSocket实现笔记编辑的实时同步

### 1.3 业务价值

- **知识沉淀**: 帮助用户记录和管理个人知识
- **团队协作**: 通过分享和协作编辑支持团队知识共享
- **冲突防止**: 通过编辑锁机制确保多人编辑时的数据一致性
- **实时协作**: 通过WebSocket实现实时内容同步，提升协作体验

---

## 2. 核心业务概念

### 2.1 笔记标签

笔记支持三种标签分类：

- **任务** (task): 与任务相关的笔记
- **灵感** (inspiration): 创意和灵感记录
- **其他** (other): 其他类型的笔记

### 2.2 权限类型

笔记分享支持两种权限：

- **只读** (readonly): 只能查看笔记，不能编辑
- **可编辑** (editable): 可以查看和编辑笔记

### 2.3 用户角色

笔记系统中的用户角色：

- **作者**: 笔记的创建者，拥有所有权限（查看、编辑、删除、分享）
- **可编辑协作者**: 被分享且拥有可编辑权限的用户，可以编辑笔记
- **只读协作者**: 被分享但只有只读权限的用户，只能查看笔记

### 2.4 编辑锁机制

编辑锁用于防止多人同时编辑造成冲突：

- **互斥编辑**: 同一时间只能有一个用户编辑笔记
- **锁超时**: 15分钟绝对超时或3分钟无活动自动释放锁
- **心跳机制**: 编辑过程中每30秒发送心跳维持锁
- **自动释放**: 用户离开或网络断开时自动释放锁

---

## 3. 业务流程

### 3.1 笔记创建流程

```
1. 用户创建笔记
   ↓
2. 选择标签（任务/灵感/其他）
   ↓
3. 输入笔记内容（可选）
   ↓
4. 保存笔记
   ↓
5. 笔记出现在笔记列表中
```

### 3.2 笔记分享流程

```
1. 笔记作者点击"分享"按钮
   ↓
2. 选择要分享的用户
   ↓
3. 设置权限（只读/可编辑）
   ↓
4. 创建分享记录
   ↓
5. 发送分享通知给被分享用户
   ↓
6. 被分享用户收到通知，笔记出现在"与我共享"列表
```

### 3.3 协作编辑流程

```
1. 用户选择要编辑的笔记
   ↓
2. 订阅 NoteEditChannel（WebSocket）
   ↓
3. 用户切换到 Write 模式
   ↓
4. 尝试获取编辑锁
   ↓
5. 锁获取结果：
   ├─ [成功] → 开始编辑，启动心跳
   │   ↓
   │   编辑内容，实时同步给其他订阅者
   │   ↓
   │   切换到 Preview 模式或离开 → 释放锁
   └─ [失败] → 显示锁冲突信息（谁在编辑、剩余时间）
       ↓
       等待锁释放后重新获取
```

### 3.4 编辑锁自动释放流程

```
编辑锁在以下情况自动释放：

1. 用户主动释放
   - 切换到 Preview 模式
   - 点击"完成编辑"按钮
   ↓
2. 超时释放
   - 3分钟无内容更新
   - 15分钟绝对超时
   ↓
3. 网络断开
   - 用户离开页面
   - WebSocket连接断开
   ↓
4. 定时任务清理
   - 每小时清理过期锁
```

### 3.5 取消分享流程

```
1. 笔记作者点击"取消分享"
   ↓
2. 选择要移除的协作者
   ↓
3. 更新分享记录（is_active=false）
   ↓
4. 发送取消分享通知
   ↓
5. 协作者收到通知，笔记从"与我共享"列表移除
```

---

## 4. 业务规则

### 4.1 笔记创建规则

1. **标签必填**: 创建笔记时必须选择标签
2. **内容长度**: 笔记内容最大1000000字符
3. **作者权限**: 笔记作者拥有所有权限

### 4.2 笔记分享规则

1. **不能分享给自己**: 不能将笔记分享给自己
2. **分享权限**: 只有笔记作者可以分享笔记
3. **权限设置**: 可以为不同用户设置不同的权限（只读/可编辑）
4. **取消分享**: 只有笔记作者可以取消分享

### 4.3 编辑权限规则

1. **作者权限**: 笔记作者始终可以编辑
2. **可编辑协作者**: 拥有可编辑权限的协作者可以编辑
3. **只读协作者**: 只读权限的协作者不能编辑
4. **权限检查**: 编辑前必须检查用户是否有编辑权限

### 4.4 编辑锁规则

#### 4.4.1 锁获取规则

1. **权限检查**: 只有有编辑权限的用户才能获取锁
2. **互斥原则**: 如果锁被其他人持有，不能获取锁
3. **过期锁处理**: 如果锁已过期，可以强制获取
4. **自己持有锁**: 如果自己已经持有锁，更新活动时间

#### 4.4.2 锁释放规则

1. **主动释放**: 用户可以主动释放锁
2. **超时释放**: 
   - 3分钟无内容更新自动释放
   - 15分钟绝对超时强制释放
3. **网络断开**: 用户离开或网络断开时自动释放
4. **定时清理**: 定时任务每小时清理过期锁

#### 4.4.3 心跳机制

1. **心跳间隔**: 编辑过程中每30秒发送一次心跳
2. **心跳作用**: 维持编辑锁，更新最后活动时间
3. **心跳超时**: 如果3分钟无心跳，自动释放锁

### 4.5 内容同步规则

1. **实时同步**: 编辑内容通过WebSocket实时同步给其他订阅者
2. **防抖保存**: 内容变更200ms防抖后保存到数据库
3. **循环避免**: 编辑者不接收自己的广播消息
4. **状态保护**: 正在编辑的用户不受其他用户的内容更新影响

### 4.6 笔记删除规则

1. **删除权限**: 只有笔记作者可以删除笔记
2. **关联删除**: 删除笔记时自动删除编辑锁和分享记录
3. **通知协作者**: 删除笔记时通知所有协作者

---

## 5. 模块关联

### 5.1 与任务系统关联

- 笔记可以关联任务（通过标签"任务"）
- 任务相关的笔记可以用于记录任务进展和想法

### 5.2 与用户系统关联

- 笔记作者和协作者都是系统中的用户
- 笔记分享涉及用户权限管理

### 5.3 与会议系统关联

- 会议笔记可以关联到个人笔记
- 会议讨论内容可以记录到笔记中

---

## 6. 详细文档链接

### 6.1 前端文档

详细的前端实现文档请参考：[笔记系统模块 - 前端文档](../frontend/note.md)

包含内容：
- 页面结构和路由
- 组件结构和说明
- Store 状态管理
- API 调用规范
- 交互流程
- UI 规范
- 权限控制

### 6.2 后端文档

详细的后端实现文档请参考：[笔记系统模块 - 后端文档](../backend/note.md)

包含内容：
- 数据模型（Model/Schema）
- API 规范（Controller/Route）
- 业务逻辑流程（Service/UseCase）
- 权限与鉴权规则
- 错误码和响应规范
- 定时任务/队列处理/事件

---

**文档版本**: v1.0  
**最后更新**: 2025-11-19  
**维护者**: GWEN开发团队
